# Copyright (c) 2024 Dell Inc., or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0

# This workflow is used to release CSI Drivers and modules.
name: Release CSM Drivers and Modules

# Invocable as a reusable workflow
on:
  workflow_call:
    inputs:
      version:
        description: "Version to release (major, minor, patch)"
        type: string
        required: true
      images:
        description: "List of image names. Example: csi-powerstore,csi-isilon"
        type: string
        required: true
      gpg_key:
        required: true
        type: string
        
jobs:
  build-and-scan:
    name: Build and Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch the full history including tags
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Install dependencies
        run: go mod tidy
      - name: Build
        if: ${{ inputs.images == 'cert-csi' }}
        run: |
          echo "Building cert-csi binary..."
          make build

  release-and-tag:
    name: Tag and Release
    needs: build-and-scan
    uses: dell/common-github-actions/.github/workflows/release-creator.yaml@meggm/test-oneclick
    with:
      version: ${{ inputs.version }}
      gpg_key: ${{ inputs.gpg_key }}
    secrets: inherit