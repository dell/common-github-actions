#!/bin/bash

set -o nounset -o pipefail

CHECK_DIRS="$1"
SCAN_FLAGS="$2"

echo === Scanning working and .git directories...
output=$(clamscan ${SCAN_FLAGS} ${CHECK_DIRS})
if echo "$output" | grep -q "FOUND"; then
    echo "Found malicious file in ref $(git rev-parse HEAD)" | tee -a /output.txt
    echo "$output" | tee -a /output.txt
else 
    echo === No malicious file Found
fi   
SCAN_RETURN_CODE=$?
echo === Finished


# Report output.
fail_checks=0
[ ${SCAN_RETURN_CODE} -ne 0 ] && echo "Malware Scanning failed checks failed!." && fail_checks=1 && cat /report.txt 

exit ${fail_checks}