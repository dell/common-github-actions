#!/bin/bash

set -o nounset -o pipefail

# Update the ClamAV Signature Database
update_signature(){
    apt-get -y install clamav clamav-daemon wget systemd
    wget --no-check-certificate https://database.clamav.net/daily.cvd
    cp daily.cvd /var/lib/clamav/daily.cvd
}

CHECK_DIRS="$1"
SCAN_FLAGS="$2"

#update_signature

echo === Scanning working and .git directories...
output=$(clamscan ${SCAN_FLAGS} ${CHECK_DIRS})
if echo "$output" | grep -q "FOUND"; then
    echo "Found malicious file in ref $(git rev-parse HEAD)" | tee -a /output.txt
    echo "$output" | tee -a /output.txt
fi
SCAN_RETURN_CODE=$?
echo === Finished

# Report output.
fail_checks=0
[ ${SCAN_RETURN_CODE} -ne 0 ] && echo "Malware Scanning failed checks failed!." && fail_checks=1 && cat /report.txt 

exit ${fail_checks}